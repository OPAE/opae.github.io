

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>OPAE Intel® FPGA Linux Device Driver Architecture &mdash; OPAE</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="OPAE" href="../../index.html"/>
        <link rel="next" title="fpgainfo" href="../fpga_tools/fpgainfo/fpgainfo.html"/>
        <link rel="prev" title="OPAE C API Reference" href="../fpga_api/fpga_api.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> OPAE
          

          
          </a>

          
            
            
              <div class="version">
                0.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">OPAE User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../fpga_api/quick_start/readme.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install_guide/installation_guide.html">OPAE Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga_api/prog_guide/readme.html">OPAE C API Programming Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ase_userguide/ase_userguide.html">OPAE AFU Simulation Environment (ASE) User Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">OPAE Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../fpga_api/fpga_api.html">OPAE C API Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">OPAE Linux Kernel Drivers</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">OPAE Intel® FPGA Linux Device Driver Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#hardware-architecture">Hardware Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fpga-management-engine-fme">FPGA Management Engine (FME)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#port">Port</a></li>
<li class="toctree-l2"><a class="reference internal" href="#accelerator-function-unit-afu">Accelerator Function Unit (AFU)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#partial-reconfiguration">Partial Reconfiguration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fpga-virtualization">FPGA Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#driver-organization">Driver Organization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pcie-module-device-driver">PCIe Module Device Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pcie-module-device-driver-functions">PCIe Module Device Driver Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fme-platform-module-device-driver">FME Platform Module Device Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fme-platform-module-device-driver-functions">FME Platform Module Device Driver Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#port-platform-module-device-driver">Port Platform Module Device Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="#port-platform-module-device-driver-functions">Port Platform Module Device Driver Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#application-fpga-device-enumeration">Application FPGA Device Enumeration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pcie-driver-enumeration">PCIe Driver Enumeration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#enumeration-data-structures">Enumeration Data Structures</a></li>
<li class="toctree-l3"><a class="reference internal" href="#enumeration-flow">Enumeration Flow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fme-platform-device-initialization">FME Platform Device Initialization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fme-platform-device-data-structures">FME Platform Device Data Structures</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fme-platform-device-initialization-flow">FME Platform Device Initialization Flow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#port-platform-device-initialization">Port Platform Device Initialization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#port-platform-device-data-structures">Port Platform Device Data Structures</a></li>
<li class="toctree-l3"><a class="reference internal" href="#port-platform-device-initialization-flow">Port Platform Device Initialization Flow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fme-ioctls">FME IOCTLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#port-ioctls">Port IOCTLs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#sysfs-files">sysfs files</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#fme-header-sysfs-files">FME Header sysfs files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fme-thermal-management-sysfs-files">FME Thermal Management sysfs files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fme-power-management-sysfs-files">FME Power Management sysfs files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fme-global-error-sysfs-files">FME Global Error sysfs files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fme-partial-reconfiguration-sysfs-files">FME Partial Reconfiguration sysfs files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fme-global-performance-sysfs-files">FME Global Performance sysfs files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#port-header-sysfs-files">Port Header sysfs files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#port-afu-header-sysfs-files">Port AFU Header sysfs files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#port-error-sysfs-files">Port Error sysfs files</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">OPAE FPGA Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../fpga_tools/fpgainfo/fpgainfo.html">fpgainfo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga_tools/fpgaconf/fpgaconf.html">fpgaconf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga_tools/fpgad/fpgad.html">fpgad</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga_tools/fpgadiag/README.html">fpgadiag</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga_tools/mmlink/mmlink.html">mmlink</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga_tools/userclk/userclk.html">userclk</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OPAE</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>OPAE Intel® FPGA Linux Device Driver Architecture</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/docs/drv_arch/drv_arch.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="opae-intel-fpga-linux-device-driver-architecture">
<h1>OPAE Intel® FPGA Linux Device Driver Architecture<a class="headerlink" href="#opae-intel-fpga-linux-device-driver-architecture" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<p>The OPAE Intel® FPGA driver provides interfaces for userspace
applications to configure, enumerate, open, and access FPGA accelerators
on platforms equipped with Intel® FPGA solutions and enables
system-level management functions such as FPGA reconfiguration, power
management, and virtualization.</p>
<div class="section" id="hardware-architecture">
<h2>Hardware Architecture<a class="headerlink" href="#hardware-architecture" title="Permalink to this headline">¶</a></h2>
<p>From the OS’s point of view, the FPGA hardware appears as a regular PCIe
device. The FPGA device memory is organized using a predefined data
structure (Device Feature List). Features supported by the particular
FPGA device are exposed through these data structures, as illustrated
below:</p>
<div class="figure" id="id1">
<img alt="FPGA PCIe Device" src="../../_images/FPGA_PCIe_Device.png" />
<p class="caption"><span class="caption-text">FPGA PCIe Device</span></p>
</div>
<p>The driver supports PCIe SR-IOV to create Virtual Functions (VFs) which
can be used to assign individual accelerators to virtual machines.</p>
<div class="figure" id="id2">
<img alt="Virtualized FPGA PCIe Device" src="../../_images/FPGA_PCIe_Device_SRIOV.png" />
<p class="caption"><span class="caption-text">Virtualized FPGA PCIe Device</span></p>
</div>
</div>
<div class="section" id="fpga-management-engine-fme">
<h2>FPGA Management Engine (FME)<a class="headerlink" href="#fpga-management-engine-fme" title="Permalink to this headline">¶</a></h2>
<p>The FPGA Management Engine performs power and thermal management, error
reporting, reconfiguration, performance reporting, and other
infrastructure functions. Each FPGA has one FME, which is always
accessed through the Physical Function (PF).</p>
<p>User-space applications can acquire exclusive access to the FME using
<code class="docutils literal"><span class="pre">open()</span></code>, and release it using <code class="docutils literal"><span class="pre">close()</span></code> as a privileged user
(root).</p>
</div>
<div class="section" id="port">
<h2>Port<a class="headerlink" href="#port" title="Permalink to this headline">¶</a></h2>
<p>A Port represents the interface between the static FPGA fabric (the
“blue bitstream”) and a partially reconfigurable region containing an
Accelerator Function Unit (AFU) (the “green bitstream”). The Port
controls the communication from software to the accelerator and exposes
features such as reset and debug.</p>
<p>A PCIe device may have several Ports, and each Port can be exposed
through a VF by assigning it using the <code class="docutils literal"><span class="pre">FPGA_FME_PORT_ASSIGN</span></code> ioctl on
the FME device.</p>
</div>
<div class="section" id="accelerator-function-unit-afu">
<h2>Accelerator Function Unit (AFU)<a class="headerlink" href="#accelerator-function-unit-afu" title="Permalink to this headline">¶</a></h2>
<p>An Accelerator Function Unit is attached to a Port and exposes a 256K
MMIO region to be used for accelerator-specific control registers.</p>
<p>User-space applications can acquire exclusive access to an AFU attached
to a Port by using <code class="docutils literal"><span class="pre">open()</span></code> on the Port device, and release it using
<code class="docutils literal"><span class="pre">close()</span></code>.</p>
<p>User-space applications can also <code class="docutils literal"><span class="pre">mmap()</span></code> accelerator MMIO regions.</p>
</div>
<div class="section" id="partial-reconfiguration">
<h2>Partial Reconfiguration<a class="headerlink" href="#partial-reconfiguration" title="Permalink to this headline">¶</a></h2>
<p>As mentioned above, accelerators can be reconfigured through partial
reconfiguration of a green bitstream file (GBS). The green bitstream
must have been generated for the exact blue bitstream and targeted
reconfigurable region (Port) of the FPGA; otherwise, the reconfiguration
operation will fail and possibly cause system instability. This
compatibility can be checked by comparing the interface ID noted in the
GBS header against the interface ID exposed by the FME through sysfs.
This check is usually done by user-space before calling the
reconfiguration IOCTL.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently, any software program accessing the FPGA, including those
running in a virtualized host, must be closed prior to attempting a Partial
Reconfiguration. The steps would be:</p>
</div>
<ol class="arabic simple">
<li>Unload the driver from the guest</li>
<li>Unplug the VF from the guest</li>
<li>Disable SR-IOV</li>
<li>Perform Partial Reconfiguration</li>
<li>Enable SR-IOV</li>
<li>Plug the VF to the guest</li>
<li>Load the driver in the guest</li>
</ol>
</div>
<div class="section" id="fpga-virtualization">
<h2>FPGA Virtualization<a class="headerlink" href="#fpga-virtualization" title="Permalink to this headline">¶</a></h2>
<p>To enable accessing an accelerator from applications running in a VM,
the respective AFU’s Port needs to be assigned to a VF using the
following steps:</p>
<ol class="arabic simple">
<li>The PF owns all AFU Ports by default. Any Port that needs to be
reassigned to a VF must be released from the PF firstly through the
<code class="docutils literal"><span class="pre">FPGA_FME_PORT_RELEASE</span></code> ioctl on the FME device.</li>
<li>Once N Ports are released from the PF, then user can use below
command to enable SRIOV and VFs. Each VF owns only one Port with AFU.</li>
</ol>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">echo N &gt; $PCI_DEVICE_PATH/sriov_numvfs</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Pass through the VFs to VMs.</li>
<li>The AFU under VF is accessible from applications in VM (using the
same driver inside the VF).</li>
</ol>
<p>Note that an FME can’t be assigned to a VF, thus PR and other management
functions are only available via the PF.</p>
</div>
<div class="section" id="driver-organization">
<h2>Driver Organization<a class="headerlink" href="#driver-organization" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pcie-module-device-driver">
<h3>PCIe Module Device Driver<a class="headerlink" href="#pcie-module-device-driver" title="Permalink to this headline">¶</a></h3>
<div class="figure" id="id3">
<img alt="Driver Organization" src="../../_images/Driver_Organization.png" />
<p class="caption"><span class="caption-text">Driver Organization</span></p>
</div>
<p>The FPGA devices appear as regular PCIe devices; thus, the FPGA PCIe
device driver (<code class="docutils literal"><span class="pre">intel-fpga-pci.ko</span></code>) is always loaded first once an
FPGA PCIe PF or VF is detected. This driver plays an infrastructural
role in the driver architecture. It:</p>
<ol class="arabic simple">
<li>Creates FPGA container device as parent of the feature devices.</li>
<li>Walks through the Device Feature List, which is implemented in PCIe
device BAR memory, to discover feature devices and their sub-features
and create platform device for them under the container device.</li>
<li>Supports SR-IOV.</li>
<li>Introduces the feature device infrastructure, which abstracts
operations for sub-features and exposes common functions to feature
device drivers.</li>
</ol>
</div>
<div class="section" id="pcie-module-device-driver-functions">
<h3>PCIe Module Device Driver Functions<a class="headerlink" href="#pcie-module-device-driver-functions" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Contains PCIe discovery, device enumeration, and feature discovery.</li>
<li>Creates sysfs directories for the parent device, FPGA Management
Engine (FME), and Port.</li>
<li>Creates the platform driver instances, causing Linux to load their
respective platform module drivers.</li>
</ul>
</div>
<div class="section" id="fme-platform-module-device-driver">
<h3>FME Platform Module Device Driver<a class="headerlink" href="#fme-platform-module-device-driver" title="Permalink to this headline">¶</a></h3>
<p>The FPGA Management Engine (FME) driver (<code class="docutils literal"><span class="pre">intel-fpga-fme.ko</span></code>) is a
platform driver which is loaded automatically after FME platform device
creation from the PCIe driver. It provides the key features for FPGA
management, including:</p>
<ol class="arabic simple">
<li>Power and thermal management, error reporting, performance reporting,
and other infrastructure functions. Users can access these functions
via sysfs interfaces exposed by FME driver.</li>
<li>Partial Reconfiguration. The FME driver registers an FPGA Manager
during PR sub-feature initialization; once it receives an
<code class="docutils literal"><span class="pre">FPGA_FME_PORT_PR</span></code> ioctl from user, it invokes the common interface
function from FPGA Manager to complete the partial reconfiguration of
the bitstream to the given Port.</li>
<li>Port management for virtualization. The FME driver introduces two
ioctls, <code class="docutils literal"><span class="pre">FPGA_FME_PORT_RELEASE</span></code>, which releases given Port from PF;
and <code class="docutils literal"><span class="pre">FPGA_FME_PORT_ASSIGN</span></code>, which assigns Port back to PF. Once the
Port is released from the PF, it can be assigned to the VF through
the SR-IOV interfaces provided by PCIe driver. (Refer to “FPGA
Virtualization” for more details).</li>
</ol>
</div>
<div class="section" id="fme-platform-module-device-driver-functions">
<h3>FME Platform Module Device Driver Functions<a class="headerlink" href="#fme-platform-module-device-driver-functions" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Creates the FME character device node.</li>
<li>Creates the FME sysfs files and implements the FME sysfs file
accessors.</li>
<li>Implements the FME private feature sub-drivers.</li>
<li>FME private feature sub-drivers:<ul>
<li>FME Header</li>
<li>Thermal Management</li>
<li>Power Management</li>
<li>Global Error</li>
<li>Partial Reconfiguration</li>
<li>Global Performance</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="port-platform-module-device-driver">
<h3>Port Platform Module Device Driver<a class="headerlink" href="#port-platform-module-device-driver" title="Permalink to this headline">¶</a></h3>
<p>Similar to the FME driver, the FPGA Port (and AFU) driver
(<code class="docutils literal"><span class="pre">intel-fpga-afu.ko</span></code>) is probed once the Port platform device is
created. The main function of this module is to provide an interface for
userspace applications to access the individual accelerators, including
basic reset control on Port, AFU MMIO region export, DMA buffer mapping
service, UMsg notification, and remote debug functions (see above).</p>
</div>
<div class="section" id="port-platform-module-device-driver-functions">
<h3>Port Platform Module Device Driver Functions<a class="headerlink" href="#port-platform-module-device-driver-functions" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Creates the Port character device node.</li>
<li>Creates the Port sysfs files and implements the Port sysfs file
accessors.</li>
<li>Implements the Port private feature sub-drivers.</li>
<li>Port private feature sub-drivers:<ul>
<li>Port Header</li>
<li>AFU</li>
<li>Port Error</li>
<li>UMsg</li>
<li>Signal Tap</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="application-fpga-device-enumeration">
<h2>Application FPGA Device Enumeration<a class="headerlink" href="#application-fpga-device-enumeration" title="Permalink to this headline">¶</a></h2>
<p>This section introduces how applications enumerate the FPGA device from
the sysfs hierarchy under <code class="docutils literal"><span class="pre">/sys/class/fpga</span></code>.</p>
<p>In the example below, two Intel® FPGA devices are installed in the host.
Each FPGA device has one FME and two Ports (AFUs).</p>
<p>For each FPGA device, a device directory is created under
<code class="docutils literal"><span class="pre">/sys/class/fpga</span></code>:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">fpga</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">dev</span><span class="mf">.0</span>
<span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">fpga</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">dev</span><span class="mf">.1</span>
</pre></div>
</div>
<p>Each node has one FME and two Ports (AFUs) as child devices:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">fpga</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">dev</span><span class="mf">.0</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">fme</span><span class="mf">.0</span>
<span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">fpga</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">dev</span><span class="mf">.0</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">port</span><span class="mf">.0</span>
<span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">fpga</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">dev</span><span class="mf">.0</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">port</span><span class="mf">.1</span>

<span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">fpga</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">dev</span><span class="mf">.1</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">fme</span><span class="mf">.1</span>
<span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">fpga</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">dev</span><span class="mf">.1</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">port</span><span class="mf">.2</span>
<span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">fpga</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">dev</span><span class="mf">.1</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">port</span><span class="mf">.3</span>
</pre></div>
</div>
<p>In general, the FME/Port sysfs interfaces are named as follows:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">fpga</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">dev</span><span class="p">.</span><span class="n">i</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">fme</span><span class="p">.</span><span class="n">j</span><span class="o">/</span>
<span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">fpga</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">dev</span><span class="p">.</span><span class="n">i</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">port</span><span class="p">.</span><span class="n">k</span><span class="o">/</span>
</pre></div>
</div>
<p>with <code class="docutils literal"><span class="pre">i</span></code> consecutively numbering all of the container devices, <code class="docutils literal"><span class="pre">j</span></code>
consecutively numbering the FME’s and <code class="docutils literal"><span class="pre">k</span></code> consecutively numbering all
Ports.</p>
<p>The device nodes used for <code class="docutils literal"><span class="pre">ioctl()</span></code> and <code class="docutils literal"><span class="pre">mmap()</span></code> can be referenced
through:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">fme</span><span class="p">.</span><span class="n">j</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">fpga</span><span class="o">-</span><span class="n">port</span><span class="p">.</span><span class="n">k</span>
</pre></div>
</div>
</div>
<div class="section" id="pcie-driver-enumeration">
<h2>PCIe Driver Enumeration<a class="headerlink" href="#pcie-driver-enumeration" title="Permalink to this headline">¶</a></h2>
<p>This section gives an overview of the code flow for device enumeration
performed by intel-fpga-pci.ko. The main data structures and functions
are highlited. This section is best followed when viewing the
accompanying source code (<code class="docutils literal"><span class="pre">pcie.c</span></code>).</p>
<div class="section" id="enumeration-data-structures">
<h3>Enumeration Data Structures<a class="headerlink" href="#enumeration-data-structures" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="n">fpga_id_type</span> <span class="p">{</span>
    <span class="n">PARENT_ID</span><span class="p">,</span>
    <span class="n">FME_ID</span><span class="p">,</span>
    <span class="n">PORT_ID</span><span class="p">,</span>
    <span class="n">FPGA_ID_MAX</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">idr</span> <span class="n">fpga_ids</span><span class="p">[</span><span class="n">FPGA_ID_MAX</span><span class="p">];</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_chardev_info</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">dev_t</span> <span class="n">devt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fpga_chardev_info</span> <span class="n">fpga_chrdevs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FPGA_FEATURE_DEV_FME</span> <span class="p">},</span>
    <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">FPGA_FEATURE_DEV_PORT</span> <span class="p">},</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">fpga_class</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">cci_pcie_id_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCIe_DEVICE_ID_RCiEP0_INTG_XEON</span><span class="p">),},</span>
    <span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCIe_DEVICE_ID_VF_INTG_XEON</span><span class="p">),},</span>
    <span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCIe_DEVICE_ID_RCiEP0_DISCRETE</span><span class="p">),},</span>
    <span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCIe_DEVICE_ID_VF_DISCRETE</span><span class="p">),},</span>
    <span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cci_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
    <span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">cci_pcie_id_tbl</span><span class="p">,</span>
    <span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">cci_pci_probe</span><span class="p">,</span>
    <span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">cci_pci_remove</span><span class="p">,</span>
    <span class="p">.</span><span class="n">sriov_configure</span> <span class="o">=</span> <span class="n">cci_pci_sriov_configure</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">cci_drvdata</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">device_id</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">fme_dev</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">port_dev_list</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">released_port_num</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">regions</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">build_feature_devs_info</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioend</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">current_bar</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pfme_hdr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent_dev</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">feature_dev</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="enumeration-flow">
<h3>Enumeration Flow<a class="headerlink" href="#enumeration-flow" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ccidrv_init()</span></code><ul>
<li>Initialize <code class="docutils literal"><span class="pre">fpga_ids</span></code> using <code class="docutils literal"><span class="pre">idr_init()</span></code>.</li>
<li>Initialize <code class="docutils literal"><span class="pre">fpga_chrdevs[i].devt</span></code> using
<code class="docutils literal"><span class="pre">alloc_chrdev_region()</span></code>.</li>
<li>Initialize <code class="docutils literal"><span class="pre">fpga_class</span></code> using <code class="docutils literal"><span class="pre">class_create()</span></code>.</li>
<li><code class="docutils literal"><span class="pre">pci_register_driver(&amp;cci_pci_driver);</span></code></li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">cci_pci_probe()</span></code><ul>
<li>Enable the PCI device, request access to its regions, set PCI
master mode, configure DMA.</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">cci_pci_create_feature_devs()</span></code> <code class="docutils literal"><span class="pre">build_info_alloc_and_init()</span></code><ul>
<li>Allocate a <code class="docutils literal"><span class="pre">struct</span> <span class="pre">build_feature_devs_info</span></code>, initialize it..</li>
<li><code class="docutils literal"><span class="pre">.parent_dev</span></code> is set to a parent sysfs directory
(intel-fpga-dev.*id*) that contains the FME and Port sysfs
directories.</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">parse_feature_list()</span></code><ul>
<li>Walk the BAR0 Device Feature List to discover the FME, the Port,
and their private features.</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">parse_feature()</span></code> <code class="docutils literal"><span class="pre">parse_feature_afus()</span></code> <code class="docutils literal"><span class="pre">parse_feature_fme()</span></code><ul>
<li>When an FME is encountered:<ul>
<li><code class="docutils literal"><span class="pre">build_info_create_dev()</span></code><ul>
<li>Allocate a platform device for the FME, storing in
<code class="docutils literal"><span class="pre">build_feature_devs_info.feature_dev</span></code>.</li>
<li><code class="docutils literal"><span class="pre">feature_dev.id</span></code> is initialized to the result of
<code class="docutils literal"><span class="pre">idr_alloc(fpga_ids[FME_ID],</span></code></li>
<li><code class="docutils literal"><span class="pre">feature_dev.parent</span></code> is set to
<code class="docutils literal"><span class="pre">build_feature_devs_info.parent_dev</span></code>.</li>
<li>Allocate an array of <code class="docutils literal"><span class="pre">struct</span> <span class="pre">resource</span></code> in
<code class="docutils literal"><span class="pre">feature_dev.resource</span></code>.</li>
</ul>
</li>
<li>Allocate a <code class="docutils literal"><span class="pre">struct</span> <span class="pre">feature_platform_data</span></code>, initialize it, and
store a pointer in <code class="docutils literal"><span class="pre">feature_dev.dev.platform_data</span></code><ul>
<li><code class="docutils literal"><span class="pre">create_feature_instance()</span></code>
<code class="docutils literal"><span class="pre">build_info_add_sub_feature()</span></code></li>
<li>Initialize <code class="docutils literal"><span class="pre">feature_dev.resource[FME_FEATURE_ID_HEADER]</span></code>.</li>
<li><code class="docutils literal"><span class="pre">feature_platform_data_add()</span></code></li>
<li>Initialize
<code class="docutils literal"><span class="pre">feature_platform_data.features[FME_FEATURE_ID_HEADER]</span></code>,
everything but .fops.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">parse_feature()</span></code> <code class="docutils literal"><span class="pre">parse_feature_afus()</span></code> <code class="docutils literal"><span class="pre">parse_feature_port()</span></code><ul>
<li>When a Port is encountered:<ul>
<li><code class="docutils literal"><span class="pre">build_info_create_dev()</span></code><ul>
<li>Allocate a platform device for the Port, storing in
<code class="docutils literal"><span class="pre">build_feature_devs_info.feature_dev</span></code>.</li>
<li><code class="docutils literal"><span class="pre">feature_dev.id</span></code> is initialized to the result of
<code class="docutils literal"><span class="pre">idr_alloc(fpga_ids[PORT_ID],</span></code></li>
<li><code class="docutils literal"><span class="pre">feature_dev.parent</span></code> is set to
<code class="docutils literal"><span class="pre">build_feature_devs_info.parent_dev</span></code>.</li>
<li>Allocate an array of <code class="docutils literal"><span class="pre">struct</span> <span class="pre">resource</span></code> in
<code class="docutils literal"><span class="pre">feature_dev.resource</span></code>.</li>
<li>Allocate a <code class="docutils literal"><span class="pre">struct</span> <span class="pre">feature_platform_data</span></code>, initialize it,
and store a pointer in <code class="docutils literal"><span class="pre">feature_dev.dev.platform_data</span></code></li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">build_info_commit_dev()</span></code><ul>
<li>Add the <code class="docutils literal"><span class="pre">struct</span> <span class="pre">feature_platform_data.node</span></code> for the Port
to the list of Ports in <code class="docutils literal"><span class="pre">struct</span> <span class="pre">cci_drvdata.port_dev_list</span></code></li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">create_feature_instance()</span></code> <code class="docutils literal"><span class="pre">build_info_add_sub_feature()</span></code><ul>
<li>Initialize <code class="docutils literal"><span class="pre">feature_dev.resource[PORT_FEATURE_ID_HEADER]</span></code>.</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">feature_platform_data_add()</span></code><ul>
<li>Initialize
<code class="docutils literal"><span class="pre">feature_platform_data.features[PORT_FEATURE_ID_HEADER]</span></code>,
everything but .fops.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">parse_feature()</span></code> <code class="docutils literal"><span class="pre">parse_feature_afus()</span></code>
<code class="docutils literal"><span class="pre">parse_feature_port_uafu()</span></code><ul>
<li>When an AFU is encountered:<ul>
<li><code class="docutils literal"><span class="pre">create_feature_instance()</span></code> <code class="docutils literal"><span class="pre">build_info_add_sub_feature()</span></code><ul>
<li>Initialize <code class="docutils literal"><span class="pre">feature_dev.resource[PORT_FEATURE_ID_UAFU]</span></code>.</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">feature_platform_data_add()</span></code><ul>
<li>Initialize
<code class="docutils literal"><span class="pre">feature_platform_data.features[PORT_FEATURE_ID_UAFU]</span></code>,
everything but .fops.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">parse_feature()</span></code> <code class="docutils literal"><span class="pre">parse_feature_private()</span></code>
<code class="docutils literal"><span class="pre">parse_feature_fme_private()</span></code><ul>
<li>When an FME private feature is encountered:<ul>
<li><code class="docutils literal"><span class="pre">create_feature_instance()</span></code> <code class="docutils literal"><span class="pre">build_info_add_sub_feature()</span></code><ul>
<li>Initialize <code class="docutils literal"><span class="pre">feature_dev.resource[id]</span></code>.</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">feature_platform_data_add()</span></code><ul>
<li>Initialize <code class="docutils literal"><span class="pre">feature_platform_data.features[id]</span></code>,
everything but .fops.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">parse_feature()</span></code> <code class="docutils literal"><span class="pre">parse_feature_private()</span></code>
<code class="docutils literal"><span class="pre">parse_feature_port_private()</span></code></li>
<li>When a Port private feature is encountered: *
<code class="docutils literal"><span class="pre">create_feature_instance()</span></code> <code class="docutils literal"><span class="pre">build_info_add_sub_feature()</span></code> *
Initialize <code class="docutils literal"><span class="pre">feature_dev.resource[id]</span></code>. *
<code class="docutils literal"><span class="pre">feature_platform_data_add()</span></code> * Initialize
<code class="docutils literal"><span class="pre">feature_platform_data.features[id]</span></code>, everything but .fops.</li>
<li><code class="docutils literal"><span class="pre">parse_ports_from_fme()</span></code><ul>
<li>If the driver is loaded on the Physical Function (PF), then..<ul>
<li>Run the <code class="docutils literal"><span class="pre">parse_feature_list()</span></code> flow on each port described in
the FME header.</li>
<li>Use the BAR mentioned in each Port entry in the header.</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="fme-platform-device-initialization">
<h2>FME Platform Device Initialization<a class="headerlink" href="#fme-platform-device-initialization" title="Permalink to this headline">¶</a></h2>
<p>This section gives an overview of the code flow for FME device
initialization performed by intel-fpga-fme.ko. The main data structures
and functions are highlited. This section is best followed when viewing
the accompanying source code (<code class="docutils literal"><span class="pre">fme-main.c</span></code>).</p>
<div class="section" id="fme-platform-device-data-structures">
<h3>FME Platform Device Data Structures<a class="headerlink" href="#fme-platform-device-data-structures" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">feature_ops</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">feature</span> <span class="o">*</span><span class="n">feature</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">uinit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">feature</span> <span class="o">*</span><span class="n">feature</span><span class="p">);</span>
    <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">ioctl</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">feature</span> <span class="o">*</span><span class="n">feature</span><span class="p">,</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">test</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">feature</span> <span class="o">*</span><span class="n">feature</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">feature</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">resource_index</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">feature_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">feature_platform_data</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dev_status</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">cdev</span> <span class="n">cdev</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">disable_count</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">config_port</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="kt">bool</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">fpga_for_each_port</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">,</span>
            <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">match</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
    <span class="k">struct</span> <span class="n">feature</span> <span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">perf_object</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">**</span><span class="n">attr_groups</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">fme_dev</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">children</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kobject</span> <span class="n">kobj</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_fme</span> <span class="p">{</span>
    <span class="n">u8</span> <span class="n">port_id</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">pr_err</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev_err</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">perf_object</span> <span class="o">*</span><span class="n">perf_dev</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">feature_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="fme-platform-device-initialization-flow">
<h3>FME Platform Device Initialization Flow<a class="headerlink" href="#fme-platform-device-initialization-flow" title="Permalink to this headline">¶</a></h3>
<div class="figure" id="id4">
<img alt="FME Initialization Flow" src="../../_images/fme_init_flow.png" />
<p class="caption"><span class="caption-text">FME Initialization Flow</span></p>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">fme_probe()</span></code> <code class="docutils literal"><span class="pre">fme_dev_init()</span></code><ul>
<li>Initialize a <code class="docutils literal"><span class="pre">struct</span> <span class="pre">fpga_fme</span></code> and store it in the
<code class="docutils literal"><span class="pre">feature_platform_data.private</span></code> field.</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">fme_probe()</span></code> <code class="docutils literal"><span class="pre">fpga_dev_feature_init()</span></code>
<code class="docutils literal"><span class="pre">feature_instance_init()</span></code><ul>
<li>Save a <code class="docutils literal"><span class="pre">struct</span> <span class="pre">feature_ops</span></code> into the
<code class="docutils literal"><span class="pre">feature_platform_data.features</span></code> for each populated feature.</li>
<li>Call the <code class="docutils literal"><span class="pre">test</span></code> function, if any, from the struct.</li>
<li>Call the <code class="docutils literal"><span class="pre">init</span></code> function from the struct.</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">fme_probe()</span></code> <code class="docutils literal"><span class="pre">fpga_register_dev_ops()</span></code><ul>
<li>Create the FME character device node, registering a
<code class="docutils literal"><span class="pre">struct</span> <span class="pre">file_operations</span></code>.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="port-platform-device-initialization">
<h2>Port Platform Device Initialization<a class="headerlink" href="#port-platform-device-initialization" title="Permalink to this headline">¶</a></h2>
<p>This section gives an overview of the code flow for port device
initialization performed by <code class="docutils literal"><span class="pre">intel-fpga-afu.ko</span></code>. The main data
structures and functions are highlighted. This section is best followed
when viewing the accompanying source code (<code class="docutils literal"><span class="pre">afu.c</span></code>).</p>
<div class="section" id="port-platform-device-data-structures">
<h3>Port Platform Device Data Structures<a class="headerlink" href="#port-platform-device-data-structures" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">feature_ops</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">feature</span> <span class="o">*</span><span class="n">feature</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">uinit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">feature</span> <span class="o">*</span><span class="n">feature</span><span class="p">);</span>
    <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">ioctl</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">feature</span> <span class="o">*</span><span class="n">feature</span><span class="p">,</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">test</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">feature</span> <span class="o">*</span><span class="n">feature</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">feature</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">resource_index</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">feature_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">feature_platform_data</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dev_status</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">cdev</span> <span class="n">cdev</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">disable_count</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">config_port</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="kt">bool</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">fpga_for_each_port</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">,</span>
            <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">match</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
    <span class="k">struct</span> <span class="n">feature</span> <span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_afu_region</span> <span class="p">{</span>
    <span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">phys</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_afu_dma_region</span> <span class="p">{</span>
    <span class="n">u64</span> <span class="n">user_addr</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">length</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">iova</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">rb_node</span> <span class="n">node</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">in_use</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_afu</span> <span class="p">{</span>
    <span class="n">u64</span> <span class="n">region_cur_offset</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_regions</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">num_umsgs</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">regions</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">dma_regions</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">feature_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="port-platform-device-initialization-flow">
<h3>Port Platform Device Initialization Flow<a class="headerlink" href="#port-platform-device-initialization-flow" title="Permalink to this headline">¶</a></h3>
<div class="figure" id="id5">
<img alt="Port Initialization Flow" src="../../_images/port_init_flow.png" />
<p class="caption"><span class="caption-text">Port Initialization Flow</span></p>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">afu_probe()</span></code> <code class="docutils literal"><span class="pre">afu_dev_init()</span></code><ul>
<li>Initialize a <code class="docutils literal"><span class="pre">struct</span> <span class="pre">fpga_afu</span></code> and store it in the
<code class="docutils literal"><span class="pre">feature_platform_data.private</span></code> field.</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">afu_probe()</span></code> <code class="docutils literal"><span class="pre">fpga_dev_feature_init()</span></code>
<code class="docutils literal"><span class="pre">feature_instance_init()</span></code><ul>
<li>Save a <code class="docutils literal"><span class="pre">struct</span> <span class="pre">feature_ops</span></code> into the
<code class="docutils literal"><span class="pre">feature_platform_data</span></code>.features for each populated feature.</li>
<li>Call the <code class="docutils literal"><span class="pre">test</span></code> function, if any, from the struct.</li>
<li>Call the <code class="docutils literal"><span class="pre">init</span></code> function from the struct.</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">afu_probe()</span></code> <code class="docutils literal"><span class="pre">fpga_register_dev_ops()</span></code><ul>
<li>Create the Port character device node, registering a
<code class="docutils literal"><span class="pre">struct</span> <span class="pre">file_operations</span></code>.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="fme-ioctls">
<h2>FME IOCTLs<a class="headerlink" href="#fme-ioctls" title="Permalink to this headline">¶</a></h2>
<p>IOCTLs that are called on an open file descriptor for
/dev/intel-fpga-fme.*j*</p>
<p><code class="docutils literal"><span class="pre">FPGA_GET_API_VERSION</span></code></p>
<ul class="simple">
<li>return the current version as an integer, starting from 0.</li>
</ul>
<p><code class="docutils literal"><span class="pre">FPGA_CHECK_EXTENSION</span></code></p>
<ul class="simple">
<li>(not currently supported).</li>
</ul>
<p><code class="docutils literal"><span class="pre">FPGA_FME_PORT_RELEASE</span></code></p>
<ul class="simple">
<li>arg is a pointer to a:</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_fme_port_release</span> <span class="p">{</span>
    <span class="n">__u32</span> <span class="n">argsz</span><span class="p">;</span>   <span class="c1">// in: sizeof(struct fpga_fme_port_release)</span>
    <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>   <span class="c1">// in: must be 0</span>
    <span class="n">__u32</span> <span class="n">port_id</span><span class="p">;</span> <span class="c1">// in: port ID (from 0) to release.</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">FPGA_FME_PORT_ASSIGN</span></code></p>
<ul class="simple">
<li>arg is a pointer to a:</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_fme_port_assign</span> <span class="p">{</span>
    <span class="n">__u32</span> <span class="n">argsz</span><span class="p">;</span>   <span class="c1">// in: sizeof(struct fpga_fme_port_assign)</span>
    <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>   <span class="c1">// in: must be 0</span>
    <span class="n">__u32</span> <span class="n">port_id</span><span class="p">;</span> <span class="c1">// in: port ID (from 0) to assign. (must have been previously released by FPGA_FME_PORT_RELEASE)</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">FPGA_FME_PORT_PR</span></code></p>
<ul class="simple">
<li>arg is a pointer to a:</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_fme_port_pr</span> <span class="p">{</span>
    <span class="n">__u32</span> <span class="n">argsz</span><span class="p">;</span>          <span class="c1">// in: sizeof(struct fpga_fme_port_pr)</span>
    <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>          <span class="c1">// in: must be 0</span>
    <span class="n">__u32</span> <span class="n">port_id</span><span class="p">;</span>        <span class="c1">// in: port ID (from 0)</span>
    <span class="n">__u32</span> <span class="n">buffer_size</span><span class="p">;</span>    <span class="c1">// in: size of bitstream buffer in bytes. Must be 4-byte aligned.</span>
    <span class="n">__u64</span> <span class="n">buffer_address</span><span class="p">;</span> <span class="c1">// in: process address of bitstream buffer</span>
    <span class="n">__u64</span> <span class="n">status</span><span class="p">;</span>         <span class="c1">// out: error status (bitmask)</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="port-ioctls">
<h2>Port IOCTLs<a class="headerlink" href="#port-ioctls" title="Permalink to this headline">¶</a></h2>
<p>IOCTLs that are called on an open file descriptor for
/dev/intel-fpga-port.*k*</p>
<p><code class="docutils literal"><span class="pre">FPGA_GET_API_VERSION</span></code></p>
<ul class="simple">
<li>return the current version as an integer, starting from 0.</li>
</ul>
<p><code class="docutils literal"><span class="pre">FPGA_CHECK_EXTENSION</span></code></p>
<ul class="simple">
<li>(not currently supported).</li>
</ul>
<p><code class="docutils literal"><span class="pre">FPGA_PORT_GET_INFO</span></code></p>
<ul class="simple">
<li>arg is a pointer to a:</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_port_info</span> <span class="p">{</span>
    <span class="n">__u32</span> <span class="n">argsz</span><span class="p">;</span>       <span class="c1">// in: sizeof(struct fpga_port_info)</span>
    <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>       <span class="c1">// out: returns 0</span>
    <span class="n">__u32</span> <span class="n">num_regions</span><span class="p">;</span> <span class="c1">// out: number of MMIO regions, 2 (1 for AFU and 1 for STP)</span>
    <span class="n">__u32</span> <span class="n">num_umsgs</span><span class="p">;</span>   <span class="c1">// out: number of UMsg&#39;s supported by the hardware</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">FPGA_PORT_GET_REGION_INFO</span></code></p>
<ul class="simple">
<li>arg is a pointer to a:</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_port_region_info</span> <span class="p">{</span>
    <span class="n">__u32</span> <span class="n">argsz</span><span class="p">;</span>   <span class="c1">// in: sizeof(struct fpga_port_region_info)</span>
    <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>   <span class="c1">// out: (bitmask) { FPGA_REGION_READ, FPGA_REGION_WRITE, FPGA_REGION_MMAP }</span>
    <span class="n">__u32</span> <span class="n">index</span><span class="p">;</span>   <span class="c1">// in: FPGA_PORT_INDEX_UAFU or FPGA_PORT_INDEX_STP</span>
    <span class="n">__u32</span> <span class="n">padding</span><span class="p">;</span> <span class="c1">// in: must be 0</span>
    <span class="n">__u64</span> <span class="n">size</span><span class="p">;</span>    <span class="c1">// out: size of MMIO region in bytes</span>
    <span class="n">__u64</span> <span class="n">offset</span><span class="p">;</span>  <span class="c1">// out: offset of MMIO region from start of device fd</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">FPGA_PORT_DMA_MAP</span></code></p>
<ul class="simple">
<li>arg is a pointer to a:</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_port_dma_map</span> <span class="p">{</span>
    <span class="n">__u32</span> <span class="n">argsz</span><span class="p">;</span>     <span class="c1">// in: sizeof(struct fpga_port_dma_map)</span>
    <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>     <span class="c1">// in: must be 0</span>
    <span class="n">__u64</span> <span class="n">user_addr</span><span class="p">;</span> <span class="c1">// in: process virtual address. Must be page aligned.</span>
    <span class="n">__u64</span> <span class="n">length</span><span class="p">;</span>    <span class="c1">// in: length of mapping in bytes. Must be a multiple of page size.</span>
    <span class="n">__u64</span> <span class="n">iova</span><span class="p">;</span>      <span class="c1">// out: IO virtual address</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">FPGA_PORT_DMA_UNMAP</span></code></p>
<ul class="simple">
<li>arg is a pointer to a:</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_port_dma_unmap</span> <span class="p">{</span>
    <span class="n">__u32</span> <span class="n">argsz</span><span class="p">;</span> <span class="c1">// in: sizeof(struct fpga_port_dma_unmap)</span>
    <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span> <span class="c1">// in: must be 0</span>
    <span class="n">__u64</span> <span class="n">iova</span><span class="p">;</span>  <span class="c1">// in: IO virtual address returned by a previous FPGA_PORT_DMA_MAP</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">FPGA_PORT_RESET</span></code></p>
<ul class="simple">
<li>arg must be NULL.</li>
</ul>
<p><code class="docutils literal"><span class="pre">FPGA_PORT_UMSG_ENABLE</span></code></p>
<ul class="simple">
<li>arg must be NULL.</li>
</ul>
<p><code class="docutils literal"><span class="pre">FPGA_PORT_UMSG_DISABLE</span></code></p>
<ul class="simple">
<li>args must be NULL.</li>
</ul>
<p><code class="docutils literal"><span class="pre">FPGA_PORT_UMSG_SET_MODE</span></code></p>
<ul class="simple">
<li>arg is a pointer to a:</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_port_umsg_cfg</span> <span class="p">{</span>
    <span class="n">__u32</span> <span class="n">argsz</span><span class="p">;</span>       <span class="c1">// in: sizeof(struct fpga_port_umsg_cfg)</span>
    <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>       <span class="c1">// in: must be 0</span>
    <span class="n">__u32</span> <span class="n">hint_bitmap</span><span class="p">;</span> <span class="c1">// in: UMsg hint mode bitmap. Signifies which UMsg&#39;s are enabled.</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">FPGA_PORT_UMSG_SET_BASE_ADDR</span></code></p>
<ul class="simple">
<li>UMsg must be disabled prior to issuing this ioctl.</li>
<li>The iova field must be for a buffer large enough for all UMsg’s
(num_umsgs * PAGE_SIZE).<ul>
<li>The buffer will be marked as “in use” by the driver’s buffer
management.</li>
<li>If iova is NULL, any previous region is unmarked as “in use”.</li>
</ul>
</li>
<li>arg is a pointer to a:</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fpga_port_umsg_base_addr</span> <span class="p">{</span>
    <span class="n">__u32</span> <span class="n">argsz</span><span class="p">;</span> <span class="c1">// in: sizeof(struct fpga_port_umsg_base_addr)</span>
    <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span> <span class="c1">// in: must be 0</span>
    <span class="n">__u64</span> <span class="n">iova</span><span class="p">;</span>  <span class="c1">// in: IO virtual address from FPGA_PORT_DMA_MAP.</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>To clear the port errors, you have to write the exact bitmask of the current errors, eg:</p>
<p class="last">$ cat errors &gt; clear</p>
</div>
</div>
</div>
<div class="section" id="sysfs-files">
<h1>sysfs files<a class="headerlink" href="#sysfs-files" title="Permalink to this headline">¶</a></h1>
<div class="section" id="fme-header-sysfs-files">
<h2>FME Header sysfs files<a class="headerlink" href="#fme-header-sysfs-files" title="Permalink to this headline">¶</a></h2>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-fme.*j*/</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="43%" />
<col width="18%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ports_num</td>
<td>fme_header.capability.num_ports</td>
<td>decimal int</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>cache_size</td>
<td>fme_header.capability.cache_size</td>
<td>decimal int</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>version</td>
<td>fme_header.capability.fabric_verid</td>
<td>decimal int</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>socket_id</td>
<td>fme_header.capability.socket_id</td>
<td>decimal int</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>bitstream_id</td>
<td>fme_header.bitstream_id</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>bitstream_metadata</td>
<td>fme_header.bitstream_md</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="fme-thermal-management-sysfs-files">
<h2>FME Thermal Management sysfs files<a class="headerlink" href="#fme-thermal-management-sysfs-files" title="Permalink to this headline">¶</a></h2>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-fme.*j*/thermal_mgmt/</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="35%" />
<col width="14%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>threshold1</td>
<td>thermal.threshold.tmp_th
shold1</td>
<td>decimal
int</td>
<td>User: Read-only Root:
Read-write</td>
</tr>
<tr class="row-odd"><td>threshold2</td>
<td>thermal.threshold.tmp_th
shold2</td>
<td>decimal
int</td>
<td>User: Read-only Root:
Read-write</td>
</tr>
<tr class="row-even"><td>threshold_tr
ip</td>
<td>thermal.threshold.therm_
trip_thshold</td>
<td>decimal
int</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>threshold1_r
eached</td>
<td>thermal.threshold.thshold
1_status</td>
<td>decimal
int</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>threshold2_r
eached</td>
<td>thermal.threshold.thshold
2_status</td>
<td>decimal
int</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>threshold1_p
olicy</td>
<td>thermal.threshold.thshold
_policy</td>
<td>decimal
int</td>
<td>User: Read-only Root:
Read-write</td>
</tr>
<tr class="row-even"><td>temperature</td>
<td>thermal.rdsensor_fm1.fpg
a_temp</td>
<td>decimal
int</td>
<td>Read-only</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="fme-power-management-sysfs-files">
<h2>FME Power Management sysfs files<a class="headerlink" href="#fme-power-management-sysfs-files" title="Permalink to this headline">¶</a></h2>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-fme.*j*/power_mgmt/</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="32%" />
<col width="18%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>consumed</td>
<td>power.status.pwr_consu
med</td>
<td>hex
uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>threshold1</td>
<td>power.threshold.thresho
ld1</td>
<td>hex
uint64_t</td>
<td>User: Read-only Root:
Read-write</td>
</tr>
<tr class="row-even"><td>threshold2</td>
<td>power.threshold.thresho
ld2</td>
<td>hex
uint64_t</td>
<td>User: Read-only Root:
Read-write</td>
</tr>
<tr class="row-odd"><td>threshold1_s
tatus</td>
<td>power.threshold.thresho
ld1_status</td>
<td>decimal
unsigned</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>threshold2_s
tatus</td>
<td>power.threshold.thresho
ld2_status</td>
<td>decimal
unsigned</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>rtl</td>
<td>power.status.fpga_late
ncy_report</td>
<td>decimal
unsigned</td>
<td>Read-only</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="fme-global-error-sysfs-files">
<h2>FME Global Error sysfs files<a class="headerlink" href="#fme-global-error-sysfs-files" title="Permalink to this headline">¶</a></h2>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-fme.*j*/errors/</p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="43%" />
<col width="20%" />
<col width="16%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>pcie0_errors</td>
<td>gerror.pcie0_err</td>
<td>hex uint64_t</td>
<td>Read-write</td>
</tr>
<tr class="row-odd"><td>pcie1_errors</td>
<td>gerror.pcie1_err</td>
<td>hex uint64_t</td>
<td>Read-write</td>
</tr>
<tr class="row-even"><td>gbs_errors</td>
<td>gerror.ras_gerr</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>bbs_errors</td>
<td>gerror.ras_berr</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>warning_errors</td>
<td>gerror.ras_werr.event_warn_err</td>
<td>hex int</td>
<td>Read-write</td>
</tr>
<tr class="row-odd"><td>inject_error</td>
<td>gerror.ras_error_inj</td>
<td>hex uint64_t</td>
<td>Read-write</td>
</tr>
</tbody>
</table>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-fme.*j*/errors/fme-errors/</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="46%" />
<col width="22%" />
<col width="15%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>errors</td>
<td>gerror.fme_err</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>first_error</td>
<td>gerror.fme_first_err.err_reg_status</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>next_error</td>
<td>gerror.fme_next_err.err_reg_status</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>clear</td>
<td>Clears errors, first_error, next_error</td>
<td>various uint64_t</td>
<td>Write-only</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To clear the FME errors, you must write the exact bitmask of the current errors, eg</p>
</div>
<div class="highlight-sh"><div class="highlight"><pre><span></span>cat errors &gt; clear
</pre></div>
</div>
</div>
<div class="section" id="fme-partial-reconfiguration-sysfs-files">
<h2>FME Partial Reconfiguration sysfs files<a class="headerlink" href="#fme-partial-reconfiguration-sysfs-files" title="Permalink to this headline">¶</a></h2>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-fme.*j*/pr/</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="51%" />
<col width="17%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>interface_i
d</td>
<td>pr.fme_pr_intfc_id0_h,
pr.fme_pre_intfc_id0_l</td>
<td>hex 16-byte</td>
<td>Read-only</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="fme-global-performance-sysfs-files">
<h2>FME Global Performance sysfs files<a class="headerlink" href="#fme-global-performance-sysfs-files" title="Permalink to this headline">¶</a></h2>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-fme.*j*/perf/clock</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="42%" />
<col width="22%" />
<col width="17%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>clock</td>
<td>gperf.clk.afu_interf_clock</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
</tbody>
</table>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-fme.*j*/perf/cache/ (Not valid for
DISCRETE)</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="36%" />
<col width="17%" />
<col width="16%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>freeze</td>
<td>gperf.ch_ctl.freeze</td>
<td>decimal int</td>
<td>Read-write</td>
</tr>
<tr class="row-odd"><td>read_hit</td>
<td>gperf.CACHE_RD_HIT</td>
<td>hex
uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>read_miss</td>
<td>gperf.CACHE_RD_MISS</td>
<td>hex
uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>write_hit</td>
<td>gperf.CACHE_WR_HIT</td>
<td>hex
uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>write_miss</td>
<td>gperf.CACHE_WR_MISS</td>
<td>hex
uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>hold_request</td>
<td>gperf.CACHE_HOLD_REQ</td>
<td>hex
uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>tx_req_stall</td>
<td>gperf.CACHE_TX_REQ_STAL
L</td>
<td>hex
uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>rx_req_stall</td>
<td>gperf.CACHE_RX_REQ_STAL
L</td>
<td>hex
uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>data_write_port_con
tention</td>
<td>gperf.CACHE_DATA_WR_POR
T_CONTEN</td>
<td>hex
uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>tag_write_port_cont
ention</td>
<td>gperf.CACHE_TAG_WR_PORT
_CONTEN</td>
<td>hex
uint64_t</td>
<td>Read-only</td>
</tr>
</tbody>
</table>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-fme.*j*/perf/iommu/ (Not valid for
DISCRETE)</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="28%" />
<col width="17%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>freeze</td>
<td>gperf.vtd_ctl.freeze</td>
<td>decimal int</td>
<td>User: Read-only Root: Read-write</td>
</tr>
</tbody>
</table>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-fme.*j*/perf/iommu/afu*k*/ (Not valid
for DISCRETE)</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="40%" />
<col width="20%" />
<col width="15%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>read_transaction</td>
<td>gperf.VTD_AFU0_MEM_RD_TRANS</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>write_transaction</td>
<td>gperf.VTD_AFU0_MEM_WR_TRANS</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>tlb_read_hit</td>
<td>gperf.VTD_AFU0_TLB_RD_HIT</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>tlb_write_hit</td>
<td>gperf.VTD_AFU0_TLB_WR_HIT</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
</tbody>
</table>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-fme.*j*/perf/fabric/</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="29%" />
<col width="18%" />
<col width="37%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>enable</td>
<td>gperf.fab_ctl.(enabled)</td>
<td>decimal int</td>
<td>User: Read-only Root: Read-write</td>
</tr>
<tr class="row-odd"><td>freeze</td>
<td>gperf.fab_ctl.freeze</td>
<td>decimal int</td>
<td>User: Read-only Root: Read-write</td>
</tr>
<tr class="row-even"><td>pcie0_read</td>
<td>gperf.FAB_PCIE0_RD</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>pcie0_write</td>
<td>gperf.FAB_PCIE0_WR</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>pcie1_read</td>
<td>gperf.FAB_PCIE1_RD</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>pcie1_write</td>
<td>gperf.FAB_PCIE1_WR</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>upi_read</td>
<td>gperf.FAB_UPI_RD</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>upi_write</td>
<td>gperf.FAB_UPI_WR</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
</tbody>
</table>
<p>intel-fpga-ev.<em>i</em>/intel-fpga/fme.*j*/perf/fabric/port*k*/</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="34%" />
<col width="24%" />
<col width="19%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>pcie0_read</td>
<td>gperf.FAB_PCIE0_RD</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>pcie0_write</td>
<td>gperf.FAB_PCIE0_WR</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>pcie1_read</td>
<td>gperf.FAB_PCIE1_RD</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>pcie1_write</td>
<td>gperf.FAB_PCIE1_WR</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>upi_read</td>
<td>gperf.FAB_UPI_RD</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>upi_write</td>
<td>gperf.FAB_UPI_WR</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="port-header-sysfs-files">
<h2>Port Header sysfs files<a class="headerlink" href="#port-header-sysfs-files" title="Permalink to this headline">¶</a></h2>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-port.*k*/</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="51%" />
<col width="18%" />
<col width="15%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>id</td>
<td>port_header.capability.port_number</td>
<td>decimal int</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>ltr</td>
<td>port_header.control.latency_tolerance</td>
<td>decimal int</td>
<td>Read-only</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="port-afu-header-sysfs-files">
<h2>Port AFU Header sysfs files<a class="headerlink" href="#port-afu-header-sysfs-files" title="Permalink to this headline">¶</a></h2>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-port.*k*/</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="32%" />
<col width="24%" />
<col width="21%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>afu_id</td>
<td>afu_header.guid</td>
<td>hex 16-byte</td>
<td>Read-only</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="port-error-sysfs-files">
<h2>Port Error sysfs files<a class="headerlink" href="#port-error-sysfs-files" title="Permalink to this headline">¶</a></h2>
<p>intel-fpga-dev.<em>i</em>/intel-fpga-port.*k*/errors/</p>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="33%" />
<col width="24%" />
<col width="16%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs file</th>
<th class="head">mmio field</th>
<th class="head">type</th>
<th class="head">access</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>errors</td>
<td>perror.port_error</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>first_error</td>
<td>perror.port_first_error</td>
<td>hex uint64_t</td>
<td>Read-only</td>
</tr>
<tr class="row-even"><td>first_malformed_req</td>
<td>perror.malreq</td>
<td>hex 16-byte</td>
<td>Read-only</td>
</tr>
<tr class="row-odd"><td>clear</td>
<td>perror.(all errors)</td>
<td>various uint64_t</td>
<td>Write-only</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To clear the Port errors, you must write the exact bitmask of the current errors, eg</p>
</div>
<div class="highlight-sh"><div class="highlight"><pre><span></span>cat errors &gt; clear
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../fpga_tools/fpgainfo/fpgainfo.html" class="btn btn-neutral float-right" title="fpgainfo" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../fpga_api/fpga_api.html" class="btn btn-neutral" title="OPAE C API Reference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017 Intel Corporation.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.9.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>